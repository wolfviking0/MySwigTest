CMAKE_MINIMUM_REQUIRED(VERSION 3.13)

PROJECT(MySwig)
  
ENABLE_LANGUAGE(C)
ENABLE_LANGUAGE(CXX)
ENABLE_LANGUAGE(ASM)

FUNCTION(GENERATE_SWIG)

    CMAKE_PARSE_ARGUMENTS(GTS "" "TARGET;RESULT;ROOT;OUTPUT" "" ${ARGN})

    IF ( EXISTS ${GTS_OUTPUT})
        FILE(REMOVE_RECURSE ${GTS_OUTPUT})
    ENDIF()
    FILE(MAKE_DIRECTORY ${GTS_OUTPUT})

    FILE(GLOB_RECURSE gen_src RELATIVE ${GTS_ROOT}
        ${GTS_ROOT}/*.i
    )

    FOREACH(FIL ${gen_src})
        SET(ABS_FIL ${GTS_ROOT}/${FIL})

        GET_FILENAME_COMPONENT(FIL_WE ${FIL} NAME_WE)
        GET_FILENAME_COMPONENT(FIL_DIR ${ABS_FIL} PATH)

        LIST(APPEND GEN_FILES ${GTS_OUTPUT}/${FIL_WE}_wrap.cxx)

        SET(OUTPUT_GEN_FILES
            "${GTS_OUTPUT}/${FIL_WE}_wrap.cxx"
        )

        SEPARATE_ARGUMENTS(EXPORT_PARAMETERS_LIST WINDOWS_COMMAND "swig -c++ -node -javascript -o ${OUTPUT_GEN_FILES} -outdir ${GTS_OUTPUT} ${ABS_FIL}")
  
        ADD_CUSTOM_COMMAND(
            OUTPUT ${OUTPUT_GEN_FILES}
            COMMAND ${EXPORT_PARAMETERS_LIST}
            DEPENDS ${ABS_FIL}
            VERBATIM
        )

    ENDFOREACH()

    ADD_CUSTOM_TARGET(${GTS_TARGET} ALL DEPENDS ${GEN_FILES})

    SET(RES )
    FOREACH(FIL ${GEN_FILES})
        SET_SOURCE_FILES_PROPERTIES(${FIL} PROPERTIES GENERATED TRUE)
        SET(RES ${RES};${FIL})
    ENDFOREACH()

    SET(${GTS_RESULT} ${RES} PARENT_SCOPE)

ENDFUNCTION()


SET(SRCS
    MySwig.cpp
)

SET(HDRS
    MySwig.h
)

GENERATE_SWIG(
    TARGET ${PROJECT_NAME}Gen
    ROOT ${CMAKE_CURRENT_SOURCE_DIR}/
    OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/gen/
    RESULT GENERATED_SRCS
)

#SET(GENERATED_SRCS ${CMAKE_CURRENT_SOURCE_DIR}/gen/MySwig_wrap.cxx)

SET(_SRCS_
    ${SRCS}
    ${GENERATED_SRCS}
)

SET(OUTPUT_DIR ${CMAKE_CURRENT_SOURCE_DIR})

ADD_CUSTOM_TARGET(${PROJECT_NAME}Javascript
    ALL
    DEPENDS ${PROJECT_NAME}Gen
    COMMAND ${CMAKE_COMMAND}
    -D OUTPUT_DIR=${OUTPUT_DIR}
    -D SRCS=${CMAKE_CURRENT_SOURCE_DIR}/${SRCS}|${GENERATED_SRCS}
    -D INCS=${CMAKE_CURRENT_SOURCE_DIR}
    -P ${CMAKE_SOURCE_DIR}/javascript.cmake
    WORKING_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}"
    COMMENT "Running Javascript Generator"
    VERBATIM)
   
